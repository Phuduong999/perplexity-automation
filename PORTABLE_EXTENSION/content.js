(()=>{"use strict";var t,e,n,o;(o=t||(t={})).READY="READY",o.LOADING="LOADING",o.DISABLED="DISABLED",o.NOT_FOUND="NOT_FOUND",function(t){t.PENDING="PENDING",t.IN_PROGRESS="IN_PROGRESS",t.COMPLETED="COMPLETED",t.FAILED="FAILED"}(e||(e={})),function(t){t.START_WORKFLOW="START_WORKFLOW",t.WORKFLOW_STATUS="WORKFLOW_STATUS",t.OPEN_OR_SWITCH_TAB="OPEN_OR_SWITCH_TAB",t.OPEN_TAB="OPEN_TAB",t.TAB_READY="TAB_READY",t.GET_MARKDOWN="GET_MARKDOWN",t.NEW_THREAD="NEW_THREAD",t.ERROR="ERROR"}(n||(n={}));class i{static log(t,...e){console.log(`${this.prefix} ${(new Date).toISOString()} - ${t}`,...e)}static error(t,...e){console.error(`${this.prefix} ${(new Date).toISOString()} - ERROR: ${t}`,...e)}static warn(t,...e){console.warn(`${this.prefix} ${(new Date).toISOString()} - WARN: ${t}`,...e)}static info(t,...e){console.info(`${this.prefix} ${(new Date).toISOString()} - INFO: ${t}`,...e)}}function a(t){return new Promise(e=>setTimeout(e,t))}i.prefix="[Perplexity Automation]";const s=new class{constructor(){this.state={currentStep:"idle",status:e.PENDING,timestamp:Date.now()},this.highlightedElements=[]}updateState(t,e,o){this.state={currentStep:t,status:e,error:o,timestamp:Date.now()},i.info(`Workflow state: ${t} - ${e}`,o||""),chrome.runtime.sendMessage({type:n.WORKFLOW_STATUS,payload:this.state}).catch(()=>{})}highlightElement(t,e,n){const o=t,i=o.style.border,a=o.style.boxShadow,s=o.style.position;o.style.border=`3px solid ${e}`,o.style.boxShadow=`0 0 10px ${e}`,o.style.position=o.style.position||"relative";const r=document.createElement("div");r.textContent=n,r.style.cssText=`\n      position: absolute;\n      top: -25px;\n      left: 0;\n      background: ${e};\n      color: white;\n      padding: 4px 8px;\n      border-radius: 4px;\n      font-size: 12px;\n      font-weight: bold;\n      z-index: 10000;\n      pointer-events: none;\n    `,o.appendChild(r),this.highlightedElements.push(o),o.__cleanup=()=>{o.style.border=i,o.style.boxShadow=a,o.style.position=s,r.parentNode&&r.remove()}}clearHighlights(){this.highlightedElements.forEach(t=>{t.__cleanup&&t.__cleanup()}),this.highlightedElements=[]}findInputElement(){const t=document.querySelector("#ask-input");return t?(i.log("‚úÖ Found input element:",t),this.highlightElement(t,"#4ECDC4","üìù INPUT"),t):(i.warn("‚ùå Input element #ask-input not found"),null)}async sendPromptToInput(t){this.updateState("send_prompt",e.IN_PROGRESS),i.log("=== Sending Prompt to Input ===");const n=this.findInputElement();if(!n)return i.error("‚ùå Cannot send prompt: Input not found"),this.updateState("send_prompt",e.FAILED,"Input not found"),!1;const o="true"===n.getAttribute("contenteditable"),s="true"===n.getAttribute("data-lexical-editor");if(i.log(`Input type: ${o?"contenteditable":"input/textarea"}, Lexical: ${s}`),n.focus(),await a(200),i.log("üóëÔ∏è Clearing existing content..."),o?(n.textContent="",n.innerHTML="",await a(200)):(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement)&&(n.value="",await a(200)),i.log("‚úÖ Content cleared"),o&&s){i.log("Setting textContent directly for Lexical editor");try{n.textContent=t,n.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!1,inputType:"insertText",data:t})),i.log(`‚úÖ textContent set directly: ${t.substring(0,50)}...`)}catch(t){return i.error("‚ùå textContent set failed:",t),this.updateState("send_prompt",e.FAILED,"textContent failed"),!1}}else(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement)&&(n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),i.log("‚úÖ Prompt set via .value"));await a(500);let r="";o?r=n.textContent?.trim()||"":(n instanceof HTMLInputElement||n instanceof HTMLTextAreaElement)&&(r=n.value.trim()),i.log(`Verification - Expected length: ${t.length}, Got length: ${r.length}`),i.log(`First 100 chars - Expected: "${t.substring(0,100)}"...`),i.log(`First 100 chars - Got: "${r.substring(0,100)}"...`);const l=Math.floor(.5*t.length);return r.length<l?(i.error(`‚ùå Prompt verification failed - too short (${r.length} < ${l})`),this.updateState("send_prompt",e.FAILED,"Prompt not set correctly"),!1):(i.log(`‚úÖ Prompt verified (length: ${r.length})`),this.updateState("send_prompt",e.COMPLETED),!0)}findSubmitButton(){const t=[{selector:'button[aria-label="Submit"]',name:"aria-submit"},{selector:'button[data-testid="submit-button"]',name:"submit-button"},{selector:'button[type="submit"]',name:"type-submit"},{selector:'form button[type="button"]',name:"form-button"},{selector:"button:has(svg)",name:"svg-button"},{selector:'button[aria-label*="ubmit"]',name:"aria-contains-submit"},{selector:"button.submit",name:"class-submit"}];for(const{selector:e,name:n}of t){const t=document.querySelector(e);if(t){const e=t.hasAttribute("disabled")||"true"===t.getAttribute("aria-disabled"),o=e?"THINKING":"READY";i.log(`‚úÖ Found button via ${n}:`,{element:t,disabled:e,state:o,ariaLabel:t.getAttribute("aria-label"),classes:t.className});const a=e?"#FFC107":"#28A745",s=e?"‚è≥ THINKING":"‚úÖ READY";return this.highlightElement(t,a,s),{element:t,state:o}}}return i.warn("‚ùå Submit button not found"),{element:null,state:"NOT_FOUND"}}async submitViaEnter(){this.updateState("click_submit",e.IN_PROGRESS),i.log("=== Submitting via Enter Key ===");const t=this.findInputElement();if(!t)return i.error("‚ùå Cannot submit: Input not found"),this.updateState("click_submit",e.FAILED,"Input not found"),!1;try{t.focus(),await a(100);const e=new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0}),n=new KeyboardEvent("keypress",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0}),o=new KeyboardEvent("keyup",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0,cancelable:!0});t.dispatchEvent(e),i.log("‚úÖ Enter keydown dispatched"),await a(50),t.dispatchEvent(n),i.log("‚úÖ Enter keypress dispatched"),await a(50),t.dispatchEvent(o),i.log("‚úÖ Enter keyup dispatched")}catch(t){return i.error("‚ùå Error submitting via Enter:",t),this.updateState("click_submit",e.FAILED,"Enter key error"),!1}return i.log("‚úÖ Enter key submitted"),this.updateState("click_submit",e.COMPLETED),!0}async clickSubmitButton(){this.updateState("click_submit",e.IN_PROGRESS),i.log("=== Clicking Submit Button ===");const{element:t,state:n}=this.findSubmitButton();if(!t)return i.error("‚ùå Cannot click: Button not found"),this.updateState("click_submit",e.FAILED,"Button not found"),!1;i.log(`Button state before click: ${n}`),i.log("Button element:",t),i.log("Button HTML:",t.outerHTML.substring(0,200)),"THINKING"===n&&i.warn("‚ö†Ô∏è Button already in THINKING state - will click anyway");try{t.scrollIntoView({behavior:"instant",block:"center"}),await a(100),t instanceof HTMLElement&&(t.focus(),i.log("‚úÖ Button focused"),await a(50)),t.click(),i.log("‚úÖ Direct click executed"),await a(100),t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),await a(50),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),i.log("‚úÖ Mouse events dispatched")}catch(t){return i.error("‚ùå Error clicking button:",t),this.updateState("click_submit",e.FAILED,"Click error"),!1}return i.log("‚úÖ Click executed"),this.updateState("click_submit",e.COMPLETED),!0}async clickNewThreadButton(){i.log("=== Clicking New Thread Button ===");const t=document.querySelector('button[data-testid="sidebar-new-thread"]');if(!t)return i.error("‚ùå New Thread button not found"),!1;i.log("‚úÖ Found New Thread button");try{return t.scrollIntoView({behavior:"instant",block:"center"}),await a(100),t.focus(),await a(50),t.click(),i.log("‚úÖ New Thread button clicked"),t.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window})),await a(50),t.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window})),i.log("‚úÖ New Thread created"),await a(2e3),!0}catch(t){return i.error("‚ùå Error clicking New Thread button:",t),!1}}findStopButton(){const t=document.querySelector('button[data-testid="stop-generating-response-button"]');if(!t)return{element:null,isThinking:!1};const e=t.hasAttribute("disabled")||"true"===t.getAttribute("aria-disabled"),n=null!==t.offsetParent,o=n&&!e;return i.log(`Stop button: ${o?"üî¥ THINKING":"‚úÖ IDLE"} (disabled: ${e}, visible: ${n})`),{element:t,isThinking:o}}async waitForThinkingComplete(t){this.updateState("wait_thinking",e.IN_PROGRESS),i.log("=== Waiting for AI to finish thinking (NO TIMEOUT) ===");const n=Date.now();let o=!1,s=0;for(;;){s++;const t=Math.round((Date.now()-n)/1e3),{isThinking:r}=this.findStopButton();if(r)o=!0,s%4==0&&i.log(`‚è≥ AI is thinking... (${t}s)`),await a(500);else{if(o&&!r)return i.log(`‚úÖ AI finished thinking! (took ${t}s)`),this.updateState("wait_thinking",e.COMPLETED),!0;if(!o&&t<5)s%4==0&&i.log(`‚è≥ Waiting for AI to start... (${t}s)`),await a(500);else{if(!o&&t>=5)return i.log("‚úÖ AI response ready (no thinking detected)"),this.updateState("wait_thinking",e.COMPLETED),!0;await a(500)}}}}async analyzeDOMStructure(){this.updateState("analyze_dom",e.IN_PROGRESS),i.log("=== Analyzing Perplexity DOM ==="),this.clearHighlights();const t=this.findInputElement(),{element:n,state:o}=this.findSubmitButton();i.log("=== Analysis Summary ===",{input:t?"‚úÖ Found":"‚ùå Not found",button:n?"‚úÖ Found":"‚ùå Not found",buttonState:o}),this.updateState("analyze_dom",e.COMPLETED),i.log("=== DOM Analysis Complete ===")}findCodeBlockContent(t){const e=`markdown-content-${t}`,n=document.querySelector(`#${e}`);if(!n)return{found:!1,id:e};this.highlightElement(n,"#9B59B6",`üìÑ ${e}`);const o=n.querySelector("code");if(!o)return{found:!0,id:e,hasCode:!1};this.highlightElement(o,"#E74C3C","üíª CODE");const i=o.textContent||"",a=i.trim();return{found:!0,id:e,hasCode:!0,rawText:i,cleanText:a,value:a,length:a.length}}scanAllCodeBlocks(t=10){const e=[];for(let n=0;n<=t;n++){const t=this.findCodeBlockContent(n);t.found&&(e.push(t),i.log(`‚úÖ Found ${t.id}:`,t.value))}return e}async extractAllContent(){this.updateState("extract_content",e.IN_PROGRESS),i.log("=== Extracting Workflow Elements ===");const t={timestamp:(new Date).toISOString(),url:window.location.href,workflow:{input:null,submitButton:null},codeBlocks:[]},n=document.querySelector("#ask-input");t.workflow.input=n?{found:!0,id:n.id,tag:n.tagName,type:n.getAttribute("type"),placeholder:n.getAttribute("placeholder"),value:n.value||"",classes:n.className}:{found:!1};const{element:o,state:a}=this.findSubmitButton();return t.workflow.submitButton=o?{found:!0,state:a,tag:o.tagName,ariaLabel:o.getAttribute("aria-label"),disabled:o.hasAttribute("disabled"),dataTestId:o.getAttribute("data-testid"),classes:o.className,innerHTML:o.innerHTML.substring(0,200)}:{found:!1},t.codeBlocks=this.scanAllCodeBlocks(10),i.log(`üìä Found ${t.codeBlocks.length} code blocks`),this.updateState("extract_content",e.COMPLETED),i.log("=== Extraction Complete ==="),t}async runWorkflow(t){i.log("=== Starting Full Workflow ===");const n=t||"Generate a random number between 1 and 100. Output only the number in a code block with no explanation.";try{if(await a(2e3),await this.analyzeDOMStructure(),i.log("‚ö†Ô∏è IMPORTANT: Must send prompt successfully before clicking submit"),!await this.sendPromptToInput(n))throw i.error("‚ùå BLOCKED: Cannot proceed without sending prompt"),new Error("Failed to send prompt to input - Submit blocked");if(i.log("‚úÖ Prompt sent successfully - Safe to click submit"),await a(500),i.log("‚è≥ Waited 500ms for prompt to settle"),i.log("‚ö†Ô∏è About to submit via button click..."),!await this.clickSubmitButton()&&(i.warn("‚ö†Ô∏è Button click failed, trying Enter key..."),!await this.submitViaEnter()))throw new Error("Failed to submit (both button click and Enter failed)");if(i.log("‚úÖ Submitted successfully"),await a(500),!await this.waitForThinkingComplete())throw new Error("Failed waiting for AI response");const t=await this.extractAllContent();return i.log("=== Workflow Completed Successfully ==="),i.log("Results:",t),this.updateState("completed",e.COMPLETED),t}catch(t){const n=t instanceof Error?t.message:"Unknown error";throw i.error("Workflow failed:",n),this.updateState("failed",e.FAILED,n),t}}getState(){return{...this.state}}};chrome.runtime.onMessage.addListener((t,e,o)=>(i.log("Content script received message:",t),(async()=>{try{switch(t.type){case n.START_WORKFLOW:{i.log("Starting DOM analysis workflow");const e=t.payload?.prompt,n=await s.runWorkflow(e);o({success:!0,results:n,state:s.getState()});break}case n.WORKFLOW_STATUS:o({success:!0,state:s.getState()});break;case n.GET_MARKDOWN:{const e=t.payload?.index??0;i.log(`Getting markdown-content-${e}`);const n=s.findCodeBlockContent(e);o({success:n.found,content:n.cleanText||null,rawText:n.rawText||null});break}case n.NEW_THREAD:{i.log("Creating new thread");const t=await s.clickNewThreadButton();o({success:t});break}case"PING":o({success:!0,status:"alive"});break;default:i.warn("Unknown message type:",t.type),o({success:!1,error:"Unknown message type"})}}catch(t){i.error("Error handling message:",t),o({success:!1,error:t instanceof Error?t.message:"Unknown error",state:s.getState()})}})(),!0)),i.log("Content script initialized on:",window.location.href)})();