(()=>{"use strict";var t,e,a;!function(t){t.READY="READY",t.LOADING="LOADING",t.DISABLED="DISABLED",t.NOT_FOUND="NOT_FOUND"}(t||(t={})),function(t){t.PENDING="PENDING",t.IN_PROGRESS="IN_PROGRESS",t.COMPLETED="COMPLETED",t.FAILED="FAILED"}(e||(e={})),function(t){t.START_WORKFLOW="START_WORKFLOW",t.WORKFLOW_STATUS="WORKFLOW_STATUS",t.OPEN_OR_SWITCH_TAB="OPEN_OR_SWITCH_TAB",t.OPEN_TAB="OPEN_TAB",t.TAB_READY="TAB_READY",t.GET_MARKDOWN="GET_MARKDOWN",t.NEW_THREAD="NEW_THREAD",t.ERROR="ERROR"}(a||(a={}));const r="dev_last_reload_timestamp";async function o(){const t=await async function(){try{const t=chrome.runtime.getURL("background.js"),e=(await fetch(t,{cache:"no-store"})).headers.get("last-modified");return e?new Date(e).getTime():Date.now()}catch{return Date.now()}}();chrome.storage.local.get([r],e=>{const a=e[r]||0;a>0&&t>a&&(console.log("ğŸ”„ Files changed, reloading extension..."),chrome.runtime.reload()),chrome.storage.local.set({[r]:t})})}!("update_url"in chrome.runtime.getManifest())&&(console.log("ğŸ”§ Development mode: Auto-reload enabled"),o(),setInterval(o,1e3));const n="https://www.perplexity.ai/";class i{static log(t,...e){console.log(`${this.prefix} ${(new Date).toISOString()} - ${t}`,...e)}static error(t,...e){console.error(`${this.prefix} ${(new Date).toISOString()} - ERROR: ${t}`,...e)}static warn(t,...e){console.warn(`${this.prefix} ${(new Date).toISOString()} - WARN: ${t}`,...e)}static info(t,...e){console.info(`${this.prefix} ${(new Date).toISOString()} - INFO: ${t}`,...e)}}async function s(){i.log("Opening or switching to Perplexity...");const t=await async function(){i.log("Searching for existing Perplexity tab...");const t=await chrome.tabs.query({});for(const e of t)if(e.url&&e.url.startsWith(n))return i.log(`Found existing tab: ${e.id} - ${e.url}`),e;return i.log("No existing Perplexity tab found"),null}();if(t&&t.id)return i.log(`Switching to existing tab: ${t.id}`),await chrome.tabs.update(t.id,{active:!0}),t.windowId&&await chrome.windows.update(t.windowId,{focused:!0}),await chrome.tabs.reload(t.id),i.log("Switched to existing tab and reloaded"),t;{i.log("Creating new Perplexity tab...");const t=await chrome.tabs.create({url:n,active:!0});return i.log(`Created new tab: ${t.id}`),t}}async function c(t,e=3e4){i.log(`Waiting for tab ${t} to be ready...`);const a=Date.now();return new Promise(r=>{const o=async()=>{try{if("complete"===(await chrome.tabs.get(t)).status)return i.log(`Tab ${t} is ready`),void r(!0);if(Date.now()-a>=e)return i.error(`Timeout waiting for tab ${t}`),void r(!1);setTimeout(o,500)}catch(e){i.error(`Error checking tab ${t}:`,e),r(!1)}};o()})}async function d(t){try{const e=await chrome.tabs.get(t);if(!e.url?.startsWith(n))return;i.log(`ğŸ” Checking content script for tab ${t}`);try{await chrome.tabs.sendMessage(t,{type:"PING"}),i.log(`âœ… Content script already loaded in tab ${t}`)}catch(e){i.log(`ğŸ’‰ Injecting content script into tab ${t}`),await chrome.scripting.executeScript({target:{tabId:t},files:["content.js"]}),i.log(`âœ… Content script injected into tab ${t}`)}}catch(t){i.error("Error ensuring content script:",t)}}i.prefix="[Background]",chrome.runtime.onMessage.addListener((t,e,r)=>(i.log("Received message:",t,"from:",e),(async()=>{try{switch(t.type){case a.OPEN_OR_SWITCH_TAB:{i.log("Handling OPEN_OR_SWITCH_TAB request");const t=await s();if(!t.id)throw new Error("Failed to get tab ID");if(!await c(t.id))throw new Error("Tab failed to load");r({success:!0,tabId:t.id,url:t.url});break}case a.OPEN_TAB:{i.log("ğŸ”„ Handling OPEN_TAB request");const e=t.payload?.url||"https://www.perplexity.ai";i.log(`ğŸ“‚ Creating new tab with URL: ${e}`);const a=await chrome.tabs.create({url:e});if(i.log(`âœ… Tab created with ID: ${a.id}`),!a.id)throw i.error("âŒ Failed to create tab - no tab ID"),new Error("Failed to create tab");i.log(`â³ Waiting for tab ${a.id} to be ready...`);const o=await c(a.id);i.log(`âœ… Tab ${a.id} ready: ${o}`);const n={success:o,tabId:a.id,url:a.url};i.log(`ğŸ“¤ Sending response: ${JSON.stringify(n)}`),r(n);break}case a.START_WORKFLOW:{i.log("Handling START_WORKFLOW request");const e=await s();if(!e.id)throw new Error("Failed to get tab ID");if(!await c(e.id))throw new Error("Tab failed to load");await async function(t,e){i.log(`Sending message to tab ${t}:`,e);try{const a=await chrome.tabs.sendMessage(t,e);return i.log(`Received response from tab ${t}:`,a),a}catch(e){throw i.error(`Error sending message to tab ${t}:`,e),e}}(e.id,{type:a.START_WORKFLOW,payload:t.payload}),r({success:!0,tabId:e.id});break}default:i.warn("Unknown message type:",t.type),r({success:!1,error:"Unknown message type"})}}catch(t){i.error("Error handling message:",t),r({success:!1,error:t instanceof Error?t.message:"Unknown error"})}})(),!0)),chrome.runtime.onInstalled.addListener(t=>{i.log("Extension installed/updated:",t.reason),"install"===t.reason?i.log("First time installation"):"update"===t.reason&&i.log("Extension updated")}),chrome.tabs.onUpdated.addListener((t,e,a)=>{"complete"===e.status&&a.url?.startsWith(n)&&(i.log(`ğŸ“„ Perplexity tab ${t} loaded, ensuring content script...`),d(t))}),chrome.tabs.onActivated.addListener(async t=>{try{const e=await chrome.tabs.get(t.tabId);e.url?.startsWith(n)&&(i.log(`ğŸ‘ï¸ Switched to Perplexity tab ${t.tabId}, ensuring content script...`),d(t.tabId))}catch(t){i.error("Error handling tab activation:",t)}}),i.log("Background script initialized")})();