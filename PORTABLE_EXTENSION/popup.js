(()=>{"use strict";var t,e,n;!function(t){t.READY="READY",t.LOADING="LOADING",t.DISABLED="DISABLED",t.NOT_FOUND="NOT_FOUND"}(t||(t={})),function(t){t.PENDING="PENDING",t.IN_PROGRESS="IN_PROGRESS",t.COMPLETED="COMPLETED",t.FAILED="FAILED"}(e||(e={})),function(t){t.START_WORKFLOW="START_WORKFLOW",t.WORKFLOW_STATUS="WORKFLOW_STATUS",t.OPEN_OR_SWITCH_TAB="OPEN_OR_SWITCH_TAB",t.OPEN_TAB="OPEN_TAB",t.TAB_READY="TAB_READY",t.GET_MARKDOWN="GET_MARKDOWN",t.NEW_THREAD="NEW_THREAD",t.ERROR="ERROR"}(n||(n={}));const o={statusDot:document.getElementById("statusDot"),statusText:document.getElementById("statusText"),openTabBtn:document.getElementById("openTabBtn"),startBtn:document.getElementById("startBtn"),progressSection:document.getElementById("progressSection"),progressSteps:document.getElementById("progressSteps"),resultSection:document.getElementById("resultSection"),resultContent:document.getElementById("resultContent"),copyBtn:document.getElementById("copyBtn"),logContent:document.getElementById("logContent")},s=[{id:"analyze_dom",label:"ğŸ” Finding Input & Submit Button"},{id:"send_prompt",label:"ğŸ“ Sending Prompt to Input"},{id:"click_submit",label:"ğŸ–±ï¸ Clicking Submit Button"},{id:"wait_thinking",label:"â³ Waiting for AI Response"},{id:"extract_content",label:"ğŸ“¦ Extracting Code Blocks"}];let r=null;function a(t,e="info"){const n=(new Date).toLocaleTimeString(),s=document.createElement("div");s.className=`log-entry ${e}`,s.textContent=`[${n}] ${t}`,o.logContent.appendChild(s),o.logContent.scrollTop=o.logContent.scrollHeight}function l(t,e="ready"){o.statusText.textContent=t,o.statusDot.className=`status-dot ${e}`}function c(){o.progressSteps.innerHTML="",s.forEach(t=>{const e=document.createElement("div");e.className="progress-step",e.id=`step-${t.id}`,e.innerHTML=`\n      <span class="step-icon">â³</span>\n      <span class="step-label">${t.label}</span>\n    `,o.progressSteps.appendChild(e)}),o.progressSection.style.display="block"}function i(t,n){const o=document.getElementById(`step-${t}`);if(!o)return;o.className="progress-step";const s=o.querySelector(".step-icon");if(s)switch(n){case e.IN_PROGRESS:o.classList.add("active"),s.textContent="â³";break;case e.COMPLETED:o.classList.add("completed"),s.textContent="âœ…";break;case e.FAILED:o.classList.add("failed"),s.textContent="âŒ"}}async function d(t){return new Promise((e,n)=>{chrome.runtime.sendMessage(t,t=>{chrome.runtime.lastError?n(chrome.runtime.lastError):e(t)})})}async function u(){try{l("Opening Perplexity...","loading"),a("Opening or switching to Perplexity tab...");const t=await d({type:n.OPEN_OR_SWITCH_TAB});if(!t.success)throw new Error(t.error||"Failed to open tab");a(`Tab ready: ${t.url}`),l("Tab opened","ready")}catch(t){const e=t instanceof Error?t.message:"Unknown error";a(`Error: ${e}`,"error"),l("Error opening tab","error"),alert(`Failed to open tab: ${e}`)}}async function p(t){try{await chrome.storage.local.set({workflowState:t}),r=t}catch(t){console.error("Failed to save workflow state:",t)}}async function E(){try{o.startBtn.disabled=!0,o.openTabBtn.disabled=!0,l("ğŸ”„ Analyzing DOM...","loading"),a("Starting DOM analysis..."),c(),o.resultSection.style.display="none";const r=await d({type:n.START_WORKFLOW});if(!r.success)throw new Error(r.error||"Analysis failed");if(a("âœ… DOM analysis completed successfully!"),l("âœ… Analysis completed","ready"),s.forEach(t=>{i(t.id,e.COMPLETED)}),r.results){t=JSON.stringify(r.results,null,2),o.resultContent.textContent=t,o.resultSection.style.display="block",a("ğŸ“Š Results extracted - check console for details"),console.log("DOM Analysis Results:",r.results)}await p({currentStep:"extract_content",status:e.COMPLETED,results:r.results,timestamp:Date.now()})}catch(t){const n=t instanceof Error?t.message:"Unknown error";a(`âŒ Analysis error: ${n}`,"error"),l("âŒ Analysis failed","error"),await p({currentStep:"failed",status:e.FAILED,error:n,timestamp:Date.now()}),alert(`Analysis failed: ${n}`)}finally{o.startBtn.disabled=!1,o.openTabBtn.disabled=!1}var t}async function y(){try{const t=o.resultContent.textContent||"";await navigator.clipboard.writeText(t);const e=o.copyBtn.textContent;o.copyBtn.textContent="âœ… Copied!",setTimeout(()=>{o.copyBtn.textContent=e},2e3),a("Result copied to clipboard")}catch(t){a("Failed to copy result","error"),alert("Failed to copy to clipboard")}}async function m(){a("ğŸš€ Popup initialized"),l("â³ Ready","ready"),await async function(){try{const t=await chrome.storage.local.get(["workflowState"]);t.workflowState&&(r=t.workflowState,a("Restored previous workflow state"),r.currentStep&&(c(),i(r.currentStep,r.status),r.status===e.COMPLETED?l("âœ… Analysis completed","ready"):r.status===e.FAILED&&l("âŒ Analysis failed","error")))}catch(t){console.error("Failed to load workflow state:",t)}}(),o.openTabBtn.addEventListener("click",u),o.startBtn.addEventListener("click",E),o.copyBtn.addEventListener("click",y),a("ğŸ’¡ Tip: Workflow runs in background even when popup is closed")}chrome.runtime.onMessage.addListener((t,o,s)=>{if(t.type===n.WORKFLOW_STATUS&&t.payload){const n=t.payload;n.currentStep&&i(n.currentStep,n.status),n.status===e.IN_PROGRESS?l(`ğŸ”„ ${n.currentStep}...`,"loading"):n.status===e.COMPLETED?l(`âœ… ${n.currentStep} completed`,"ready"):n.status===e.FAILED&&l(`âŒ ${n.currentStep} failed`,"error"),p(n)}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()})();